---
title: 腾讯云 COS 配置
description: 配置 PocketBase 使用腾讯云对象存储 COS
updatedDate: 2025-01-12
difficulty: intermediate
---

腾讯云对象存储（Cloud Object Storage，COS）是腾讯云提供的安全、稳定、高效、低成本的云端存储服务。本文介绍如何配置 PocketBase 使用腾讯云 COS。

## 前置准备

### 开通 COS 服务

1. 登录 [腾讯云控制台](https://console.cloud.tencent.com/cos)
2. 开通对象存储服务（新用户通常有免费额度）
3. 创建存储桶

### 创建存储桶

<Steps>

1. **进入 COS 控制台**

   访问 [腾讯云 COS 控制台](https://console.cloud.tencent.com/cos5/bucket)。

2. **创建存储桶**

   点击「创建存储桶」，配置：

   | 配置项   | 推荐值                       |
   | -------- | ---------------------------- |
   | 名称     | `your-app-files`（全球唯一） |
   | 所属地域 | `ap-guangzhou`（广州）       |
   | 访问权限 | **私有读写**（推荐）         |
   | 版本控制 | 暂不开启                     |
   | 存储类型 | 标准存储                     |

3. **记录存储桶信息**

   创建后记录以下信息：
   - 存储桶名称：`your-app-files-1234567890`
   - 所属地域：`ap-guangzhou`
   - 访问域名：`https://your-app-files-1234567890.cos.ap-guangzhou.myqcloud.com`

</Steps>

### 获取 API 密钥

<Steps>

1. **访问密钥管理**

   进入 [API 密钥管理](https://console.cloud.tencent.com/cam/capi)。

2. **创建密钥**
   - 主账号密钥：具有所有权限（不推荐用于应用）
   - 子账号密钥：推荐使用，按需分配权限

3. **记录密钥信息**
   - SecretId：`AKIDxxxxxxxxxxxxxxxx`
   - SecretKey：`xxxxxxxxxxxxxxxx`

</Steps>

### 创建子账号（推荐）

为了安全，建议为 PocketBase 创建专用的子账号：

<Steps>

1. **进入访问管理**

   访问 [CAM 控制台](https://console.cloud.tencent.com/cam)。

2. **创建用户**
   - 用户名：`pocketbase-cos`
   - 访问方式：**编程访问**
   - **不要**启用「控制台密码登录」

3. **创建权限策略**

   创建自定义策略 `PocketBaseCOSAccess`：

   ```json
   {
     "version": "2.0",
     "statement": [
       {
         "effect": "allow",
         "action": [
           "cos:PutObject",
           "cos:GetObject",
           "cos:DeleteObject",
           "cos:HeadObject",
           "cos:OptionsObject"
         ],
         "resource": ["qcs::cos:ap-guangzhou:uid/*:your-app-files-1234567890/*"]
       },
       {
         "effect": "allow",
         "action": ["cos:GetBucket", "cos:ListObjects"],
         "resource": ["qcs::cos:ap-guangzhou:uid/*:your-app-files-1234567890"]
       }
     ]
   }
   ```

4. **授权用户**

   将策略关联到 `pocketbase-cos` 用户。

5. **创建密钥**

   为用户创建 AccessKey 并保存。

</Steps>

## PocketBase 配置

### 通过管理后台配置

1. 登录 PocketBase 管理后台
2. 进入 **Settings** → **S3 Storage**
3. 填写配置：

   | 配置项           | 值                                             |
   | ---------------- | ---------------------------------------------- |
   | Endpoint         | `https://cos.ap-guangzhou.myqcloud.com`        |
   | Bucket           | `your-app-files-1234567890`（包含 AppID 后缀） |
   | Region           | `ap-guangzhou`                                 |
   | Access Key       | SecretId                                       |
   | Secret           | SecretKey                                      |
   | Force path style | **关闭**                                       |

### 通过命令行配置

```bash
./pocketbase serve \
  --s3Endpoint="https://cos.ap-guangzhou.myqcloud.com" \
  --s3Bucket="your-app-files-1234567890" \
  --s3Region="ap-guangzhou" \
  --s3AccessKey="AKIDxxxxxxxx" \
  --s3Secret="xxxxxxxxxxxx"
```

### 环境变量配置

```bash
# .env
COS_ENDPOINT=https://cos.ap-guangzhou.myqcloud.com
COS_BUCKET=your-app-files-1234567890
COS_REGION=ap-guangzhou
COS_ACCESS_KEY=AKIDxxxxxxxx
COS_SECRET_KEY=xxxxxxxxxxxx

# 启动时加载
./pocketbase serve \
  --s3Endpoint="${COS_ENDPOINT}" \
  --s3Bucket="${COS_BUCKET}" \
  --s3Region="${COS_REGION}" \
  --s3AccessKey="${COS_ACCESS_KEY}" \
  --s3Secret="${COS_SECRET_KEY}"
```

## 区域选择

### 地域对照表

| 地域代码         | 地域名称 | Endpoint                            |
| ---------------- | -------- | ----------------------------------- |
| ap-beijing       | 北京     | `cos.ap-beijing.myqcloud.com`       |
| ap-shanghai      | 上海     | `cos.ap-shanghai.myqcloud.com`      |
| ap-guangzhou     | 广州     | `cos.ap-guangzhou.myqcloud.com`     |
| ap-chengdu       | 成都     | `cos.ap-chengdu.myqcloud.com`       |
| ap-chongqing     | 重庆     | `cos.ap-chongqing.myqcloud.com`     |
| ap-hongkong      | 香港     | `cos.ap-hongkong.myqcloud.com`      |
| ap-singapore     | 新加坡   | `cos.ap-singapore.myqcloud.com`     |
| ap-tokyo         | 东京     | `cos.ap-tokyo.myqcloud.com`         |
| na-siliconvalley | 硅谷     | `cos.na-siliconvalley.myqcloud.com` |
| na-ashburn       | 弗吉尼亚 | `cos.na-ashburn.myqcloud.com`       |
| eu-frankfurt     | 法兰克福 | `cos.eu-frankfurt.myqcloud.com`     |

### 选择建议

| 用户分布      | 推荐地域                           |
| ------------- | ---------------------------------- |
| 中国大陆      | 选择距离最近的地域（如广州、上海） |
| 香港/海外用户 | 选择香港或新加坡地域               |
| 全球业务      | 考虑使用 CDN 加速                  |

## 文件访问配置

### 私有读配置

存储桶设置为私有读写时，需要通过 PocketBase 获取临时访问 URL：

```javascript
// 前端获取文件 URL
const pb = new PocketBase("https://api.example.com");

// 获取文件 URL（带签名）
const fileUrl = pb.files.getUrl(record, "avatar.jpg");

// 获取缩略图 URL（带签名）
const thumbUrl = pb.files.getUrl(record, "avatar.jpg", {
  thumb: "200x200",
});
```

### 公有读配置

如果需要公开访问文件：

1. 进入存储桶配置
2. **安全管理** → **权限管理**
3. 添加以下策略：

   ```json
   {
     "version": "2.0",
     "statement": [
       {
         "effect": "allow",
         "principal": {
           "qcs": ["*"]
         },
         "action": ["cos:GetObject"],
         "resource": [
           "qcs::cos:ap-guangzhou:uid/*:your-app-files-1234567890/public/*"
         ]
       }
     ]
   }
   ```

4. 在 PocketBase 中将文件存储到 `public/` 子目录

### 使用 CDN 加速

腾讯云 COS 可配合 CDN 使用：

<Steps>

1. **创建 CDN 加速域名**

   在 [CDN 控制台](https://console.cloud.tencent.com/cdn) 添加域名。

2. **配置源站**
   - 源站类型：COS 域名
   - 源站地址：`your-app-files-1234567890.cos.ap-guangzhou.myqcloud.com`

3. **配置缓存规则**

   | 文件类型 | 缓存时间 |
   | -------- | -------- |
   | 图片     | 30 天    |
   | 视频     | 30 天    |
   | 静态文件 | 7 天     |
   | 其他     | 1 天     |

4. **获取 CDN 域名**

   例如：`https://cdn.example.com`

5. **配置 PocketBase 使用 CDN**

   ```javascript
   // 自定义文件 URL 生成
   pb.files.getTokenUrl = function (record, filename, options) {
     const cdnDomain = "https://cdn.example.com";
     const path = `/api/files/${record.collectionId}/${record.id}/${filename}`;

     // 私有文件需要签名
     if (options?.token) {
       const token = options.token || this.files.getToken();
       return `${cdnDomain}${path}?token=${token}`;
     }

     return `${cdnDomain}${path}`;
   };
   ```

</Steps>

## 迁移现有文件

### 从本地存储迁移

<Steps>

1. **备份现有数据**

   ```bash
   # 备份整个 pb_data 目录
   tar -czf pb_data_backup.tar.gz pb_data/
   ```

2. **使用 COSCMD 工具上传**

   安装 COSCMD：

   ```bash
   pip install coscmd
   ```

   配置：

   ```bash
   coscmd config -a AKIDxxx -s xxxxx -b your-app-files-1234567890 -r ap-guangzhou
   ```

   上传文件：

   ```bash
   # 上传整个存储目录
   coscmd upload -r pb_data/storage/ / --delete
   ```

3. **配置 PocketBase 使用 COS**

   按照前面的步骤配置 S3 存储。

4. **验证文件访问**

   确保所有现有文件可以正常访问。

5. **清理本地文件**

   确认一切正常后，可以删除本地存储释放空间。

</Steps>

### 从其他存储迁移

使用 rclone 在不同存储间迁移：

```bash
# 安装 rclone
curl https://rclone.org/install.sh | sudo bash

# 配置腾讯云 COS
rclone config
# 名称：cos
# 类型：S3
# Provider: Other
# Endpoint: https://cos.ap-guangzhou.myqcloud.com
# Access Key ID: AKIDxxx
# Secret Access Key: xxxxx
# ACL: private

# 迁移数据
rclone sync source:bucket cos:your-app-files-1234567890 --progress
```

## 常见问题

### Q: 签名不匹配（SignatureDoesNotMatch）？

**可能原因：**

1. AccessKey 或 SecretKey 错误
2. 存储桶名称或区域配置错误
3. 系统时间不同步

**解决方案：**

```bash
# 同步系统时间
sudo ntpdate -u time.nist.gov

# 检查配置
echo "Endpoint: https://cos.ap-guangzhou.myqcloud.com"
echo "Bucket: your-app-files-1234567890 (包含 AppID)"
echo "Region: ap-guangzhou"
```

### Q: 文件上传成功但无法访问？

**可能原因：**

1. 存储桶是私有读权限
2. CORS 未配置

**解决方案：**

```javascript
// 前端获取带签名的 URL
const fileUrl = pb.files.getUrl(record, "file.jpg");
```

配置 CORS：

1. 进入存储桶 → **安全管理** → **COS 规则** → **CORS 配置**
2. 添加规则：

   ```json
   {
     "AllowedOrigins": ["https://yourdomain.com"],
     "AllowedMethods": ["GET", "PUT", "POST", "DELETE"],
     "AllowedHeaders": ["*"],
     "ExposeHeaders": ["ETag"],
     "MaxAgeSeconds": 3600
   }
   ```

### Q: Bucket 名称格式错误？

腾讯云 COS 的 Bucket 名称格式为 `{name}-{appid}`：

```
正确: myapp-files-1234567890
错误: myapp-files
```

AppID 可在控制台右上角的「账号信息」中找到。

### Q: 如何处理大文件上传？

COS 攐供分片上传功能：

```javascript
// 前端大文件上传示例
async function uploadLargeFile(file) {
  const chunkSize = 1024 * 1024; // 1MB
  const chunks = Math.ceil(file.size / chunkSize);

  for (let i = 0; i < chunks; i++) {
    const start = i * chunkSize;
    const end = Math.min((i + 1) * chunkSize, file.size);
    const chunk = file.slice(start, end);

    const formData = new FormData();
    formData.append("file", chunk);
    formData.append("chunkIndex", i);
    formData.append("totalChunks", chunks);

    await pb.send("/api/upload-chunk", {
      method: "POST",
      body: formData,
    });
  }
}
```

## 成本优化

### 存储类型选择

| 存储类型 | 适用场景           | 成本（约）   |
| -------- | ------------------ | ------------ |
| 标准存储 | 热数据，频繁访问   | ¥0.118/GB/月 |
| 低频存储 | 不常访问的数据     | ¥0.08/GB/月  |
| 归档存储 | 很少访问，长期保存 | ¥0.033/GB/月 |
| 深度归档 | 极少访问，合规保存 | ¥0.012/GB/月 |

### 生命周期规则

自动转换存储类型：

1. 进入存储桶 → **文件管理** → **生命周期**
2. 添加规则：

   ```json
   {
     "name": "降冷规则",
     "status": "Enabled",
     "transitions": [
       {
         "days": 30,
         "storageClass": "STANDARD_IA"
       },
       {
         "days": 90,
         "storageClass": "ARCHIVE"
       }
     ]
   }
   ```

## 下一步

- [S3 兼容存储配置](/guides/storage/s3) - 了解其他 S3 兼容存储
- [阿里云 OSS 配置](/guides/storage/aliyun-oss) - 使用阿里云 OSS
- [文件处理指南](/docs/guides/files-handling) - 文件上传与处理
