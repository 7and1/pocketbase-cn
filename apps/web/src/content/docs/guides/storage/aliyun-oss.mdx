---
title: 阿里云 OSS 存储配置
description: PocketBase 配置阿里云 OSS 作为 S3 兼容存储的完整指南
---

import {
  Steps,
  Aside,
  Tabs,
  TabItem,
  Code,
} from "@astrojs/starlight/components";

PocketBase 原生支持 S3 兼容的对象存储服务，阿里云 OSS（Object Storage Service）是国内最常用的云存储服务之一。本文将详细介绍如何配置 PocketBase 使用阿里云 OSS 存储文件。

## 为什么使用阿里云 OSS

在生产环境中，将文件存储从本地迁移到云存储有以下优势：

- **高可用性**：阿里云 OSS 提供 99.995% 的可用性保障
- **弹性扩展**：存储容量无上限，按需付费
- **CDN 加速**：可配合阿里云 CDN 实现全球加速
- **数据安全**：支持跨区域复制、版本控制和数据加密
- **成本优化**：标准存储约 0.12 元/GB/月，流量计费灵活

## 前置条件

在开始配置之前，请确保您已具备：

- 已注册阿里云账号并完成实名认证
- PocketBase 版本 0.16.0 或更高（S3 存储支持）
- 基本的命令行操作能力

## 创建 OSS Bucket

<Steps>

1. **登录阿里云控制台**

   访问 [阿里云 OSS 控制台](https://oss.console.aliyun.com/)，使用您的账号登录。

2. **创建 Bucket**

   点击「创建 Bucket」按钮，填写以下信息：

   | 配置项      | 推荐值           | 说明                                     |
   | ----------- | ---------------- | ---------------------------------------- |
   | Bucket 名称 | `your-app-files` | 全局唯一，只能包含小写字母、数字和短横线 |
   | 地域        | `华东1（杭州）`  | 选择离您服务器最近的地域                 |
   | 存储类型    | `标准存储`       | 频繁访问的文件选择标准存储               |
   | 读写权限    | `私有`           | 建议选择私有，通过 PocketBase 控制访问   |
   | 版本控制    | `开启`           | 可选，用于文件版本管理和误删恢复         |

3. **记录 Endpoint 信息**

   创建成功后，在 Bucket 概览页面记录以下信息：
   - **Bucket 域名**：`your-app-files.oss-cn-hangzhou.aliyuncs.com`
   - **Endpoint**：`oss-cn-hangzhou.aliyuncs.com`
   - **Region**：`oss-cn-hangzhou`

</Steps>

<Aside type="tip">
  选择地域时，优先考虑您服务器所在的地域。同地域内的 OSS
  访问走内网，不产生流量费用且延迟更低。
</Aside>

## 配置 CORS 跨域

如果您的前端需要直接上传文件到 OSS（客户端直传），需要配置 CORS：

<Steps>

1. **进入跨域设置**

   在 Bucket 管理页面，选择「数据安全」->「跨域设置」。

2. **创建 CORS 规则**

   点击「创建规则」，配置如下：

   ```
   来源: https://your-domain.com
   允许 Methods: GET, POST, PUT, DELETE, HEAD
   允许 Headers: *
   暴露 Headers: ETag, x-oss-request-id
   缓存时间: 3600
   ```

3. **保存规则**

   点击「确定」保存配置。

</Steps>

<Aside type="caution">
  生产环境中请勿将「来源」设置为 `*`，应明确指定您的域名，防止跨站请求伪造。
</Aside>

## 获取 AccessKey

PocketBase 需要 AccessKey 来访问 OSS API。推荐使用 RAM 用户的 AccessKey，而非主账号。

<Steps>

1. **创建 RAM 用户**

   访问 [RAM 控制台](https://ram.console.aliyun.com/users)，点击「创建用户」：

   | 配置项   | 值                        |
   | -------- | ------------------------- |
   | 登录名称 | `pocketbase-oss`          |
   | 显示名称 | `PocketBase OSS 访问用户` |
   | 访问方式 | 勾选「OpenAPI 调用访问」  |

2. **保存 AccessKey**

   创建成功后，**立即保存** AccessKey ID 和 AccessKey Secret。

   <Aside type="danger">
     AccessKey Secret
     仅显示一次，请务必妥善保存。建议使用密码管理器存储，切勿提交到代码仓库。
   </Aside>

3. **授权 OSS 访问权限**

   为 RAM 用户添加权限策略。您可以选择：

   **方式一：使用系统策略（简单但权限较大）**
   - 添加系统策略 `AliyunOSSFullAccess`

   **方式二：自定义策略（推荐，最小权限原则）**

   创建自定义策略，仅授权特定 Bucket 的访问权限：

   ```json
   {
     "Version": "1",
     "Statement": [
       {
         "Effect": "Allow",
         "Action": [
           "oss:PutObject",
           "oss:GetObject",
           "oss:DeleteObject",
           "oss:ListObjects",
           "oss:GetBucketInfo"
         ],
         "Resource": [
           "acs:oss:*:*:your-app-files",
           "acs:oss:*:*:your-app-files/*"
         ]
       }
     ]
   }
   ```

</Steps>

## PocketBase 配置

### 通过管理界面配置

<Steps>

1. **登录管理后台**

   访问 `http://your-server:8090/_/` 并登录管理员账号。

2. **进入设置页面**

   点击左侧菜单的「Settings」（设置）。

3. **配置 S3 存储**

   在「Files storage」（文件存储）部分，启用「Use S3 storage」并填写：

   | 配置项           | 值                                     | 说明                        |
   | ---------------- | -------------------------------------- | --------------------------- |
   | Endpoint         | `https://oss-cn-hangzhou.aliyuncs.com` | 需要加 `https://` 前缀      |
   | Bucket           | `your-app-files`                       | 您创建的 Bucket 名称        |
   | Region           | `oss-cn-hangzhou`                      | OSS 地域标识                |
   | Access Key       | `LTAI5t...`                            | RAM 用户的 AccessKey ID     |
   | Secret           | `your-secret-key`                      | RAM 用户的 AccessKey Secret |
   | Force path style | 关闭                                   | 阿里云 OSS 使用虚拟主机风格 |

4. **保存并测试**

   点击「Save」保存配置，然后上传一个测试文件验证配置是否正确。

</Steps>

### 通过环境变量配置

如果您使用 Docker 或需要通过环境变量管理配置：

```bash
# 启动 PocketBase 时设置 S3 参数
./pocketbase serve \
  --s3Endpoint="https://oss-cn-hangzhou.aliyuncs.com" \
  --s3Bucket="your-app-files" \
  --s3Region="oss-cn-hangzhou" \
  --s3AccessKey="LTAI5t..." \
  --s3Secret="your-secret-key"
```

Docker Compose 配置示例：

```yaml
version: "3.8"

services:
  pocketbase:
    image: ghcr.io/muchobien/pocketbase:latest
    container_name: pocketbase
    restart: unless-stopped
    ports:
      - "127.0.0.1:8090:8090"
    volumes:
      - ./pb_data:/pb/pb_data
    environment:
      - TZ=Asia/Shanghai
    command: >
      ./pocketbase serve
      --http=0.0.0.0:8090
      --s3Endpoint=https://oss-cn-hangzhou.aliyuncs.com
      --s3Bucket=your-app-files
      --s3Region=oss-cn-hangzhou
      --s3AccessKey=${OSS_ACCESS_KEY}
      --s3Secret=${OSS_SECRET_KEY}
```

配合 `.env` 文件：

```ini
OSS_ACCESS_KEY=LTAI5t...
OSS_SECRET_KEY=your-secret-key
```

<Aside type="tip">
  使用环境变量存储敏感信息，避免在配置文件中明文保存 AccessKey。
</Aside>

## 测试上传

配置完成后，使用以下方法验证 OSS 存储是否正常工作：

### 方法一：通过管理后台

1. 在 PocketBase 管理后台创建一个包含 `file` 类型字段的 Collection
2. 添加一条记录并上传文件
3. 检查 OSS Bucket 中是否出现新文件

### 方法二：通过 API

```bash
# 创建记录并上传文件
curl -X POST http://localhost:8090/api/collections/files/records \
  -H "Content-Type: multipart/form-data" \
  -F "file=@/path/to/your/test-file.jpg"
```

### 方法三：通过 JavaScript SDK

```javascript
import PocketBase from "pocketbase";

const pb = new PocketBase("http://localhost:8090");

// 上传文件
const formData = new FormData();
formData.append("file", fileInput.files[0]);

const record = await pb.collection("files").create(formData);
console.log("上传成功:", record.file);
```

## 验证文件存储位置

上传成功后，登录阿里云 OSS 控制台，进入您的 Bucket，可以看到文件已存储在类似以下路径：

```
your-app-files/
└── collection_id/
    └── record_id/
        └── filename.jpg
```

## 配置 CDN 加速（可选）

为了提升全国用户的访问速度，建议配置阿里云 CDN：

<Steps>

1. **开通 CDN 服务**

   访问 [阿里云 CDN 控制台](https://cdn.console.aliyun.com/)，开通 CDN 服务。

2. **添加加速域名**
   - 加速域名：`cdn.your-domain.com`
   - 业务类型：`图片小文件`
   - 源站信息：选择 OSS 域名 `your-app-files.oss-cn-hangzhou.aliyuncs.com`

3. **配置 CNAME**

   在您的 DNS 服务商处，添加 CNAME 记录指向阿里云提供的 CDN 域名。

4. **配置 HTTPS**

   在 CDN 控制台配置 SSL 证书，启用 HTTPS 访问。

5. **更新 PocketBase 配置**

   在 PocketBase 设置中，将文件 URL 前缀更新为 CDN 域名。

</Steps>

## 常见问题

### Q: 出现 SignatureDoesNotMatch 错误？

**原因**：AccessKey 或 Secret 配置错误，或系统时间不同步。

**解决方案**：

```bash
# 1. 检查 AccessKey 是否正确（注意首尾空格）
echo $OSS_ACCESS_KEY | cat -A

# 2. 同步系统时间
sudo ntpdate ntp.aliyun.com
```

### Q: 出现 AccessDenied 错误？

**原因**：RAM 用户权限不足或 Bucket 策略限制。

**解决方案**：

1. 确认 RAM 用户已添加 OSS 访问权限
2. 检查 Bucket Policy 是否有 IP 或来源限制
3. 确认 Bucket 名称拼写正确

### Q: 如何迁移现有文件到 OSS？

如果您已有本地存储的文件，需要迁移到 OSS：

```bash
# 使用 ossutil 工具上传
# 1. 下载安装 ossutil
curl -o ossutil https://gosspublic.alicdn.com/ossutil/1.7.14/ossutil64
chmod +x ossutil

# 2. 配置认证信息
./ossutil config \
  -e oss-cn-hangzhou.aliyuncs.com \
  -i LTAI5t... \
  -k your-secret-key

# 3. 同步 pb_data/storage 目录到 OSS
./ossutil sync pb_data/storage/ oss://your-app-files/ --update
```

<Aside type="caution">
  迁移前请备份数据，并在测试环境验证后再进行生产环境迁移。
</Aside>

### Q: 如何设置文件过期自动删除？

在 OSS 控制台配置生命周期规则：

1. 进入 Bucket 管理 -> 基础设置 -> 生命周期
2. 创建规则，设置前缀（如 `temp/`）和过期天数
3. 保存规则

### Q: 内网访问如何配置？

如果 PocketBase 服务器在阿里云 ECS 上，使用内网 Endpoint 可免流量费：

```
# 外网 Endpoint
oss-cn-hangzhou.aliyuncs.com

# 内网 Endpoint（仅限同地域 ECS）
oss-cn-hangzhou-internal.aliyuncs.com
```

### Q: 如何估算存储成本？

阿里云 OSS 标准存储定价（华东1区域）：

| 费用项目            | 价格          |
| ------------------- | ------------- |
| 存储费用            | 0.12 元/GB/月 |
| 外网流出流量        | 0.50 元/GB    |
| API 调用（PUT/GET） | 0.01 元/万次  |

示例：10GB 文件 + 100GB 月流量 + 10 万次 API 调用

- 存储：10 × 0.12 = 1.2 元
- 流量：100 × 0.50 = 50 元
- API：10 × 0.01 = 0.1 元
- **合计**：约 51.3 元/月

使用 CDN 后，流量费用可降低约 50%。

## 安全最佳实践

1. **使用 RAM 用户**：不要使用主账号 AccessKey
2. **最小权限原则**：仅授予必要的 Bucket 权限
3. **开启日志**：在 OSS 控制台启用访问日志记录
4. **防盗链设置**：配置 Referer 白名单防止资源盗链
5. **定期轮换密钥**：定期更换 AccessKey
6. **启用版本控制**：防止文件被误删除

## 下一步

- 了解 [S3 兼容存储配置](/guides/storage/s3) 以支持更多存储服务
- 配置 [生产环境检查清单](/deploy/production-checklist) 确保应用安全
- 探索 [文件处理](/docs/guides/files-handling) 了解更多文件操作
