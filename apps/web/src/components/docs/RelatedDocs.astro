---
/**
 * RelatedDocs Component
 *
 * Displays related documentation based on the current document's section.
 * Uses local content collection data for reliable internal linking.
 */
import { getCollection } from "astro:content";

interface Props {
  currentId?: string;
  limit?: number;
}

const { currentId = "", limit = 5 } = Astro.props;

const docs = await getCollection("docs");

function normalizeId(id: string) {
  return String(id || "").replace(/^\/+|\/+$/g, "");
}

function routeForId(id: string) {
  const normalized = normalizeId(id);
  if (!normalized) return "/";
  if (normalized.endsWith("/index"))
    return `/${normalized.slice(0, -"/index".length)}/`;
  if (normalized === "index") return "/";
  return `/${normalized}/`;
}

const normalizedId = normalizeId(currentId);
const segments = normalizedId.split("/").filter(Boolean);
const section = segments.slice(0, 2).join("/");

const inSection = section
  ? docs.filter((doc) => normalizeId(doc.id).startsWith(`${section}/`))
  : docs;

let related = inSection.filter(
  (doc) => normalizeId(doc.id) !== normalizedId,
);

if (related.length < limit) {
  const fallback = docs
    .filter((doc) => normalizeId(doc.id) !== normalizedId)
    .filter(
      (doc) =>
        !related.some((item) => normalizeId(item.id) === normalizeId(doc.id)),
    );
  related = related.concat(fallback);
}

const displayDocs = related.slice(0, limit).map((doc) => ({
  title: doc.data.title || doc.id,
  description: doc.data.description || "",
  href: routeForId(doc.id),
}));
---

{displayDocs.length > 0 && (
  <aside class="rounded-xl border border-neutral-200 bg-neutral-50 p-6 dark:border-neutral-800 dark:bg-neutral-900">
    <h3 class="text-lg font-semibold">相关文档</h3>
    <p class="mt-1 text-sm text-neutral-600 dark:text-neutral-400">
      推荐阅读以下相关内容
    </p>

    <ul class="mt-4 space-y-3">
      {displayDocs.map((doc) => (
        <li>
          <a
            href={doc.href}
            class="group block rounded-lg p-3 transition-colors hover:bg-neutral-100 dark:hover:bg-neutral-800"
          >
            <div class="flex items-start gap-3">
              <span class="mt-0.5 text-brand-600 dark:text-brand-400">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z" />
                  <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" />
                </svg>
              </span>
              <div class="min-w-0 flex-1">
                <h4 class="font-medium text-neutral-900 group-hover:text-brand-700 dark:text-neutral-100 dark:group-hover:text-brand-300">
                  {doc.title}
                </h4>
                {doc.description ? (
                  <p class="mt-1 text-sm text-neutral-600 dark:text-neutral-400">
                    {doc.description}
                  </p>
                ) : null}
              </div>
            </div>
          </a>
        </li>
      ))}
    </ul>

    <a
      href="/docs"
      class="mt-4 inline-flex items-center gap-1 text-sm font-medium text-brand-700 hover:underline dark:text-brand-300"
    >
      查看所有文档
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="14"
        height="14"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <path d="M5 12h14" />
        <path d="m12 5 7 7-7 7" />
      </svg>
    </a>
  </aside>
)}
