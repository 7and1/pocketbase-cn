name: Health Monitor

on:
  schedule:
    # Run every 5 minutes
    - cron: "*/5 * * * *"
  workflow_dispatch:

jobs:
  production-health:
    name: Production Health Check
    runs-on: ubuntu-latest
    timeout-minutes: 2
    steps:
      - name: Check /api/live
        id: live-check
        continue-on-error: true
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.PRODUCTION_URL }}/api/live)
          echo "Response code: $response"
          if [ "$response" != "200" ]; then
            echo "Health check failed"
            exit 1
          fi

      - name: Check /api/ready
        id: ready-check
        continue-on-error: true
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.PRODUCTION_URL }}/api/ready)
          echo "Response code: $response"
          if [ "$response" != "200" ]; then
            echo "Readiness check failed"
            exit 1
          fi

      - name: Check API response time
        id: response-time
        continue-on-error: true
        run: |
          time_total=$(curl -s -o /dev/null -w "%{time_total}" ${{ secrets.PRODUCTION_URL }}/api/live)
          echo "Response time: ${time_total}s"
          # Alert if response time exceeds 5 seconds
          if (( $(echo "$time_total > 5" | bc -l) )); then
            echo "Response time too high: ${time_total}s"
            exit 1
          fi

      - name: Alert on failure
        if: failure() && steps.live-check.outcome == 'failure' || steps.ready-check.outcome == 'failure' || steps.response-time.outcome == 'failure'
        run: |
          if [ -n "${{ secrets.ALERT_WEBHOOK_URL }}" ]; then
            curl -X POST "${{ secrets.ALERT_WEBHOOK_URL }}" \
              -H "Content-Type: application/json" \
              -d '{
                "text": "üö® Production Health Check Failed",
                "blocks": [
                  {
                    "type": "header",
                    "text": {
                      "type": "plain_text",
                      "text": "üö® Production Health Alert"
                    }
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "*Environment:* Production\n*URL:* ${{ secrets.PRODUCTION_URL }}\n*Time:* '"$(date -u +%Y-%m-%d\ %H:%M:%S\ UTC)"'"
                    }
                  }
                ]
              }'
          fi

  staging-health:
    name: Staging Health Check
    runs-on: ubuntu-latest
    timeout-minutes: 2
    steps:
      - name: Check /api/live
        id: live-check
        continue-on-error: true
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.STAGING_URL }}/api/live)
          echo "Response code: $response"
          if [ "$response" != "200" ]; then
            echo "Health check failed"
            exit 1
          fi

      - name: Check /api/ready
        id: ready-check
        continue-on-error: true
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.STAGING_URL }}/api/ready)
          echo "Response code: $response"
          if [ "$response" != "200" ]; then
            echo "Readiness check failed"
            exit 1
          fi

      - name: Alert on failure
        if: failure()
        run: |
          if [ -n "${{ secrets.ALERT_WEBHOOK_URL }}" ]; then
            curl -X POST "${{ secrets.ALERT_WEBHOOK_URL }}" \
              -H "Content-Type: application/json" \
              -d '{
                "text": "‚ö†Ô∏è Staging Health Check Failed",
                "blocks": [
                  {
                    "type": "header",
                    "text": {
                      "type": "plain_text",
                      "text": "‚ö†Ô∏è Staging Health Alert"
                    }
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "*Environment:* Staging\n*URL:* ${{ secrets.STAGING_URL }}\n*Time:* '"$(date -u +%Y-%m-%d\ %H:%M:%S\ UTC)"'"
                    }
                  }
                ]
              }'
          fi
