---
title: S3 兼容存储配置
description: 配置 PocketBase 使用 AWS S3 或兼容存储服务
---

import {
  Steps,
  Aside,
  Tabs,
  TabItem,
  Code,
} from "@astrojs/starlight/components";

PocketBase 内置支持 S3 兼容的对象存储服务，可以将文件存储从本地迁移到云端。本文介绍如何配置各种 S3 兼容存储服务，包括 AWS S3、MinIO、Cloudflare R2 等。

## S3 存储概述

### 什么是 S3 兼容存储

S3（Simple Storage Service）是 Amazon Web Services 推出的对象存储服务，其 API 已成为行业标准。众多云服务商都提供 S3 兼容的存储服务，使用相同的 API 接口，可以无缝切换。

### PocketBase 的文件存储

PocketBase 默认将上传的文件存储在本地 `pb_data/storage` 目录。启用 S3 存储后：

- 所有新上传的文件将存储到 S3
- 文件 URL 将指向 S3 存储
- 支持配置自定义域名和 CDN

### 支持的存储服务

| 服务商        | 特点                   | 适用场景           |
| ------------- | ---------------------- | ------------------ |
| AWS S3        | 全球覆盖，功能最完善   | 国际业务，海外用户 |
| 阿里云 OSS    | 国内最大，访问速度快   | 中国大陆业务       |
| 腾讯云 COS    | 国内主流，微信生态集成 | 微信小程序         |
| Cloudflare R2 | 零出口流量费           | 高流量应用         |
| MinIO         | 开源自建，数据自主     | 私有化部署         |
| Backblaze B2  | 性价比高               | 备份存储           |

## 通用配置步骤

无论使用哪种 S3 兼容服务，配置流程都类似：

<Steps>

1. **创建存储桶（Bucket）**

   在云服务商控制台创建一个新的存储桶，记录：
   - Bucket 名称
   - Region（区域）
   - Endpoint（接入点）

2. **获取访问凭证**

   创建具有存储桶访问权限的 API 密钥：
   - Access Key ID
   - Secret Access Key

3. **配置 PocketBase**

   在管理后台或通过命令行参数配置 S3 连接信息。

4. **测试验证**

   上传测试文件，确认文件正确存储到 S3。

</Steps>

## AWS S3 配置

### 创建 S3 Bucket

<Steps>

1. **登录 AWS 控制台**

   访问 [AWS S3 控制台](https://s3.console.aws.amazon.com/)。

2. **创建存储桶**

   点击「Create bucket」，配置：

   | 配置项              | 推荐值                         |
   | ------------------- | ------------------------------ |
   | Bucket name         | `your-app-files`               |
   | AWS Region          | `ap-northeast-1`（东京）或其他 |
   | Object Ownership    | ACLs disabled                  |
   | Block Public Access | 全部启用（推荐）               |
   | Bucket Versioning   | Enable（推荐）                 |

3. **配置 CORS**

   进入 Bucket -> Permissions -> CORS，添加：

   ```json
   [
     {
       "AllowedHeaders": ["*"],
       "AllowedMethods": ["GET", "PUT", "POST", "DELETE", "HEAD"],
       "AllowedOrigins": ["https://your-domain.com"],
       "ExposeHeaders": ["ETag"],
       "MaxAgeSeconds": 3600
     }
   ]
   ```

</Steps>

### 创建 IAM 用户

<Steps>

1. **进入 IAM 控制台**

   访问 [AWS IAM 控制台](https://console.aws.amazon.com/iam/)。

2. **创建用户**

   Users -> Add users：
   - User name: `pocketbase-s3`
   - Access type: Programmatic access

3. **创建策略**

   创建自定义策略，仅授权必要权限：

   ```json
   {
     "Version": "2012-10-17",
     "Statement": [
       {
         "Effect": "Allow",
         "Action": [
           "s3:PutObject",
           "s3:GetObject",
           "s3:DeleteObject",
           "s3:ListBucket"
         ],
         "Resource": [
           "arn:aws:s3:::your-app-files",
           "arn:aws:s3:::your-app-files/*"
         ]
       }
     ]
   }
   ```

4. **附加策略并保存密钥**

   将策略附加到用户，保存 Access Key ID 和 Secret Access Key。

</Steps>

### PocketBase 配置

通过管理后台配置：

| 配置项           | 值                                        |
| ---------------- | ----------------------------------------- |
| Endpoint         | `https://s3.ap-northeast-1.amazonaws.com` |
| Bucket           | `your-app-files`                          |
| Region           | `ap-northeast-1`                          |
| Access Key       | 您的 Access Key ID                        |
| Secret           | 您的 Secret Access Key                    |
| Force path style | 关闭                                      |

或使用命令行：

```bash
./pocketbase serve \
  --s3Endpoint="https://s3.ap-northeast-1.amazonaws.com" \
  --s3Bucket="your-app-files" \
  --s3Region="ap-northeast-1" \
  --s3AccessKey="AKIA..." \
  --s3Secret="your-secret-key"
```

## Cloudflare R2 配置

Cloudflare R2 的最大优势是**零出口流量费用**，非常适合高流量应用。

### 创建 R2 Bucket

<Steps>

1. **登录 Cloudflare Dashboard**

   访问 [Cloudflare Dashboard](https://dash.cloudflare.com/)，进入 R2。

2. **创建存储桶**

   点击「Create bucket」：
   - Bucket name: `your-app-files`
   - Location: Auto（自动）

3. **创建 API Token**

   进入 R2 -> Overview -> Manage R2 API Tokens：
   - Token name: `pocketbase-access`
   - Permissions: Object Read & Write
   - Specify bucket: 选择您的 bucket

4. **保存凭证**

   记录以下信息：
   - Account ID（在 R2 概览页面）
   - Access Key ID
   - Secret Access Key

</Steps>

### PocketBase 配置

R2 的 Endpoint 格式为：`https://<account-id>.r2.cloudflarestorage.com`

| 配置项           | 值                                                 |
| ---------------- | -------------------------------------------------- |
| Endpoint         | `https://your-account-id.r2.cloudflarestorage.com` |
| Bucket           | `your-app-files`                                   |
| Region           | `auto`                                             |
| Access Key       | R2 Access Key ID                                   |
| Secret           | R2 Secret Access Key                               |
| Force path style | 开启                                               |

<Aside type="tip">
  Cloudflare R2 需要**开启 Force path style**，这与其他 S3 服务不同。
</Aside>

### 配置公共访问域名

R2 默认不提供公共访问 URL，需要配置自定义域名或使用 R2.dev 子域名：

1. 在 R2 Bucket 设置中启用「Public access」
2. 配置自定义域名（需要在 Cloudflare 管理的域名）
3. 或启用 R2.dev 子域名（开发测试用）

## MinIO 自建存储

MinIO 是开源的 S3 兼容存储系统，适合私有化部署。

### 使用 Docker 部署 MinIO

```yaml
# docker-compose.yml
version: "3.8"

services:
  minio:
    image: minio/minio:latest
    container_name: minio
    restart: unless-stopped
    ports:
      - "9000:9000" # API 端口
      - "9001:9001" # 控制台端口
    volumes:
      - ./minio_data:/data
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: your-secure-password
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3

  pocketbase:
    image: ghcr.io/muchobien/pocketbase:latest
    container_name: pocketbase
    restart: unless-stopped
    ports:
      - "8090:8090"
    volumes:
      - ./pb_data:/pb/pb_data
    depends_on:
      - minio
```

### 创建 Bucket 和 Access Key

<Steps>

1. **访问 MinIO 控制台**

   打开 `http://your-server:9001`，使用 root 用户登录。

2. **创建 Bucket**

   Buckets -> Create Bucket：
   - Bucket Name: `pocketbase-files`
   - Versioning: Enable（推荐）

3. **创建 Access Key**

   Identity -> Service Accounts -> Create Service Account：
   - 保存生成的 Access Key 和 Secret Key

4. **配置访问策略**

   为 Service Account 分配 `readwrite` 策略或自定义策略。

</Steps>

### PocketBase 配置

```bash
./pocketbase serve \
  --s3Endpoint="http://minio:9000" \
  --s3Bucket="pocketbase-files" \
  --s3Region="us-east-1" \
  --s3AccessKey="minioaccesskey" \
  --s3Secret="miniosecretkey" \
  --s3ForcePathStyle=true
```

<Aside type="caution">
  MinIO 必须开启 `s3ForcePathStyle`，因为它使用路径风格的 URL。
</Aside>

## 腾讯云 COS 配置

腾讯云 COS（Cloud Object Storage）是国内主流的对象存储服务。

### 创建存储桶

<Steps>

1. **登录腾讯云控制台**

   访问 [腾讯云 COS 控制台](https://console.cloud.tencent.com/cos)。

2. **创建存储桶**

   | 配置项     | 推荐值                |
   | ---------- | --------------------- |
   | 存储桶名称 | `your-app-files`      |
   | 所属地域   | `ap-shanghai`（上海） |
   | 访问权限   | 私有读写              |
   | 版本控制   | 开启                  |

3. **获取访问域名**

   记录存储桶访问域名：`your-app-files-1234567890.cos.ap-shanghai.myqcloud.com`

</Steps>

### 创建 API 密钥

访问 [API 密钥管理](https://console.cloud.tencent.com/cam/capi)：

1. 创建子用户或使用现有用户
2. 生成 SecretId 和 SecretKey
3. 授予 COS 相关权限

### PocketBase 配置

腾讯云 COS 的 Endpoint 格式：`https://cos.<region>.myqcloud.com`

| 配置项           | 值                                             |
| ---------------- | ---------------------------------------------- |
| Endpoint         | `https://cos.ap-shanghai.myqcloud.com`         |
| Bucket           | `your-app-files-1234567890`（包含 AppID 后缀） |
| Region           | `ap-shanghai`                                  |
| Access Key       | SecretId                                       |
| Secret           | SecretKey                                      |
| Force path style | 关闭                                           |

<Aside type="tip">
  腾讯云 COS 的 Bucket 名称格式为 `bucket-name-appid`，需要包含 AppID 后缀。
</Aside>

## 存储服务对比

### 价格对比（每月 100GB 存储 + 500GB 流量）

| 服务商         | 存储费用   | 流量费用 | 总计（约）   |
| -------------- | ---------- | -------- | ------------ |
| AWS S3（标准） | $2.30      | $45.00   | $47.30       |
| 阿里云 OSS     | ¥12        | ¥250     | ¥262         |
| 腾讯云 COS     | ¥11.8      | ¥250     | ¥261.8       |
| Cloudflare R2  | $1.50      | $0       | $1.50        |
| Backblaze B2   | $0.50      | $5.00    | $5.50        |
| MinIO（自建）  | 服务器成本 | -        | 取决于服务器 |

<Aside type="tip">
  如果您的应用流量较大，Cloudflare R2 的零出口流量费可以大幅降低成本。
</Aside>

### 功能对比

| 特性         | AWS S3     | 阿里云 OSS | Cloudflare R2  | MinIO      |
| ------------ | ---------- | ---------- | -------------- | ---------- |
| 国内访问速度 | 一般       | 快         | 快             | 取决于部署 |
| 版本控制     | 支持       | 支持       | 不支持         | 支持       |
| 生命周期管理 | 支持       | 支持       | 支持           | 支持       |
| CDN 集成     | CloudFront | 阿里云 CDN | Cloudflare CDN | 需自建     |
| 数据自主     | 否         | 否         | 否             | 是         |

## 迁移指南

### 从本地存储迁移到 S3

<Steps>

1. **备份现有数据**

   ```bash
   # 备份整个 pb_data 目录
   tar -czf pb_data_backup.tar.gz pb_data/
   ```

2. **上传现有文件到 S3**

   使用 AWS CLI 或各服务商的工具：

   ```bash
   # AWS S3
   aws s3 sync pb_data/storage/ s3://your-bucket/

   # 阿里云 OSS
   ossutil sync pb_data/storage/ oss://your-bucket/

   # MinIO
   mc mirror pb_data/storage/ myminio/your-bucket/
   ```

3. **配置 PocketBase 使用 S3**

   在管理后台配置 S3 存储信息。

4. **验证文件访问**

   访问现有记录的文件，确认可以正常加载。

5. **清理本地文件（可选）**

   确认一切正常后，可以删除本地 `pb_data/storage` 目录释放空间。

</Steps>

<Aside type="caution">
  迁移过程中请勿删除本地文件，直到确认 S3
  存储完全正常工作。建议保留备份至少一周。
</Aside>

### 在不同 S3 服务间迁移

使用 rclone 可以方便地在不同存储服务间迁移：

```bash
# 安装 rclone
curl https://rclone.org/install.sh | sudo bash

# 配置源和目标
rclone config

# 迁移数据
rclone sync source:bucket dest:bucket --progress
```

## 高级配置

### 配置文件 URL 前缀

如果使用自定义域名或 CDN，需要配置文件 URL 前缀：

```bash
./pocketbase serve \
  --s3Endpoint="https://s3.amazonaws.com" \
  --s3Bucket="your-bucket" \
  --s3Region="us-east-1" \
  --s3AccessKey="..." \
  --s3Secret="..." \
  --backupsS3Endpoint="https://s3.amazonaws.com" \
  --backupsS3Bucket="your-backups-bucket"
```

### 分离文件存储和备份存储

PocketBase 支持为文件和备份使用不同的 S3 存储：

```bash
# 文件存储使用 R2（零流量费）
--s3Endpoint="https://account.r2.cloudflarestorage.com"
--s3Bucket="files"

# 备份存储使用 B2（低成本）
--backupsS3Endpoint="https://s3.us-west-000.backblazeb2.com"
--backupsS3Bucket="backups"
```

## 常见问题

### Q: 如何处理大文件上传？

对于大文件（>100MB），建议：

1. 在 Collection 设置中配置最大文件大小
2. 确保 S3 服务支持分片上传
3. 配置适当的超时时间

### Q: 文件上传失败，提示 SignatureDoesNotMatch？

**原因**：

- Access Key 或 Secret 错误
- 系统时间不同步
- Endpoint 配置错误

**解决**：

```bash
# 同步系统时间
sudo timedatectl set-ntp true

# 检查 Endpoint 格式
# 正确: https://s3.region.amazonaws.com
# 错误: https://s3.region.amazonaws.com/
```

### Q: 如何配置跨区域复制？

大多数 S3 服务都支持跨区域复制，用于灾备：

1. 创建目标区域的 Bucket
2. 在源 Bucket 配置复制规则
3. 授予必要的跨区域访问权限

### Q: 如何限制文件类型？

在 PocketBase Collection 的文件字段中配置：

- Allowed MIME types: `image/jpeg,image/png,image/gif`
- Max file size: `5242880`（5MB）

### Q: 如何设置文件自动过期？

使用 S3 生命周期规则：

```json
{
  "Rules": [
    {
      "ID": "delete-temp-files",
      "Filter": { "Prefix": "temp/" },
      "Status": "Enabled",
      "Expiration": { "Days": 7 }
    }
  ]
}
```

## 安全建议

1. **使用 IAM/RAM 用户**：不要使用根账户凭证
2. **最小权限原则**：仅授予必要的 S3 权限
3. **启用访问日志**：监控异常访问
4. **配置 CORS**：限制允许的来源域名
5. **使用 HTTPS**：确保传输加密
6. **定期轮换密钥**：建议每 90 天更换一次
7. **启用版本控制**：防止误删除

## 下一步

- 查看 [阿里云 OSS 配置](/guides/storage/aliyun-oss) 了解详细的阿里云配置
- 了解 [文件处理](/docs/guides/files-handling) 探索更多文件操作
- 配置 [生产环境检查清单](/deploy/production-checklist) 确保应用安全
