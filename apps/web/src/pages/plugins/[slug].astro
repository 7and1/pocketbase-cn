---
export const prerender = false;

import BaseLayout from "@/layouts/BaseLayout.astro";
import { POCKETBASE_URL } from "@/lib/constants/config";
import { renderMarkdownSafe } from "@/lib/utils/markdown";
import StarButton from "@/components/plugins/StarButton";
import CommentsThread from "@/components/comments/CommentsThread";
import { pocketbaseFileUrl } from "@/lib/utils/fileUrl";

const { slug } = Astro.params;
if (!slug) return Astro.redirect("/plugins");

const res = await fetch(`${POCKETBASE_URL}/api/plugins/${encodeURIComponent(slug)}`, {
  headers: { Accept: "application/json" }
});

if (!res.ok) return Astro.redirect("/plugins");

const json = await res.json();
const plugin = json?.data;
const readmeHtml = renderMarkdownSafe(String(plugin?.readme || ""));
const iconUrl = plugin?.icon ? pocketbaseFileUrl("plugins", String(plugin?.id || ""), String(plugin.icon), { thumb: "100x100" }) : "";
const screenshots = Array.isArray(plugin?.screenshots) ? plugin.screenshots : [];

// SoftwareSourceCode schema data
const pluginSchemaData = {
  name: plugin?.name,
  description: plugin?.description,
  authorName: plugin?.author || "PocketBase Community",
  authorType: "Organization",
  language: plugin?.language || "JavaScript",
  repository: plugin?.repository,
  aggregateRating: plugin?.stats?.stars ? {
    value: Math.min(5, (plugin?.stats?.stars || 0) / 10 + 3.5),
    count: plugin?.stats?.stars || 0
  } : undefined
};
---

<BaseLayout
  title={`${plugin?.name || slug} - 插件 - PocketBase.cn`}
  description={plugin?.description || ""}
  schemaType="SoftwareSourceCode"
  schemaData={pluginSchemaData}
>
  <div class="flex flex-col gap-6 md:flex-row md:items-start md:justify-between">
    <div class="min-w-0">
      <div class="flex items-center gap-3">
        {iconUrl ? (
          <img src={iconUrl} alt={`${plugin?.name || slug} 图标`} class="h-10 w-10 rounded bg-neutral-100 object-cover dark:bg-neutral-900" width={40} height={40} />
        ) : null}
        <h1 class="text-2xl font-semibold tracking-tight">{plugin?.name}</h1>
      </div>
      <p class="mt-2 text-neutral-700 dark:text-neutral-300">{plugin?.description}</p>
      <div class="mt-4 flex flex-wrap gap-2 text-sm">
        {plugin?.category ? (
          <span class="rounded bg-neutral-100 px-2 py-1 dark:bg-neutral-800">{plugin.category}</span>
        ) : null}
        {Array.isArray(plugin?.tags)
          ? plugin.tags.slice(0, 6).map((t) => (
              <span class="rounded bg-neutral-100 px-2 py-1 dark:bg-neutral-800">{t}</span>
            ))
          : null}
      </div>
    </div>

    <div class="w-full md:w-64">
      <div class="rounded-xl border border-neutral-200 p-4 dark:border-neutral-800">
        <div class="flex items-center justify-between">
          <div class="text-sm text-neutral-600 dark:text-neutral-400">Stars</div>
          <div class="text-lg font-semibold">{plugin?.stats?.stars ?? 0}</div>
        </div>
        <div class="mt-2 flex items-center justify-between">
          <div class="text-sm text-neutral-600 dark:text-neutral-400">Downloads</div>
          <div class="text-lg font-semibold">{plugin?.stats?.downloads_total ?? 0}</div>
        </div>
        <div class="mt-2 flex items-center justify-between">
          <div class="text-sm text-neutral-600 dark:text-neutral-400">GitHub Stars</div>
          <div class="text-lg font-semibold">{plugin?.github_stars ?? 0}</div>
        </div>
        <div class="mt-4">
          <StarButton slug={String(slug)} client:load />
        </div>
        {plugin?.repository ? (
          <a
            class="mt-3 block rounded-md border border-neutral-200 px-3 py-2 text-center text-sm font-medium hover:bg-neutral-50 focus:outline-none focus:ring-2 focus:ring-brand-500 focus:ring-offset-2 dark:border-neutral-800 dark:hover:bg-neutral-900"
            href={plugin.repository}
            target="_blank"
            rel="noopener noreferrer"
          >
            打开仓库
          </a>
        ) : null}
      </div>
    </div>
  </div>

  <section class="mt-10">
    <h2 class="text-lg font-semibold">README</h2>
    <div class="prose mt-4 max-w-none dark:prose-invert">
      <Fragment set:html={readmeHtml} />
    </div>
  </section>

  {Array.isArray(screenshots) && screenshots.length ? (
    <section class="mt-10">
      <h2 class="text-lg font-semibold">截图</h2>
      <div class="mt-4 grid gap-3 md:grid-cols-2">
        {screenshots.map((f, index) => (
          <img
            src={pocketbaseFileUrl("plugins", String(plugin?.id || ""), String(f), { thumb: "640x480" })}
            alt={`${plugin?.name || slug} 截图 ${index + 1}`}
            class="aspect-video w-full rounded-lg border border-neutral-200 object-cover dark:border-neutral-800"
            loading="lazy"
            width={640}
            height={480}
          />
        ))}
      </div>
    </section>
  ) : null}

  {Array.isArray(plugin?.versions) && plugin.versions.length ? (
    <section class="mt-10">
      <h2 class="text-lg font-semibold">版本</h2>
      <div class="mt-4 overflow-hidden rounded-xl border border-neutral-200 dark:border-neutral-800">
        <table class="w-full text-sm">
          <thead class="bg-neutral-50 text-left dark:bg-neutral-900">
            <tr>
              <th class="px-4 py-2">Version</th>
              <th class="px-4 py-2">Downloads</th>
              <th class="px-4 py-2">Link</th>
            </tr>
          </thead>
          <tbody>
            {plugin.versions.map((v) => (
              <tr class="border-t border-neutral-200 dark:border-neutral-800">
                <td class="px-4 py-2">{v.version}</td>
                <td class="px-4 py-2">{v.downloads ?? 0}</td>
                <td class="px-4 py-2">
                  <a
                    class="text-brand-700 hover:underline dark:text-brand-300"
                    href={`${POCKETBASE_URL}/api/plugins/${encodeURIComponent(String(slug))}/download?version=${encodeURIComponent(String(v.version))}`}
                    target="_blank"
                    rel="noopener noreferrer"
                  >
                    下载（计数）
                  </a>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </section>
  ) : null}

  <section class="mt-10">
    <CommentsThread pluginSlug={String(slug)} client:load />
  </section>
</BaseLayout>
